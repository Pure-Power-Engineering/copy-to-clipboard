<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Copy SharePoint Link</title>
    <script>
      window.addEventListener('load', async () => {
        const url = new URL(window.location.href);
        let bodyText;
        let success = false;
        let copiedValue = '';

        if (url.searchParams.has('copy')) {
          // Raw SharePoint FileRef (e.g. /sites/.../Shared Documents/File Name.docx)
          const rawPath = url.searchParams.get('copy');

          // 1. Build absolute URL
          const tenantBase = 'https://ppepvp.sharepoint.com';
          const absoluteUrl = tenantBase + rawPath;

          // 2. For Office docs, force open-in-browser with ?web=1
          const officeExtPattern = /\.(docx?|pptx?|xlsx?)$/i;
          let finalUrl = absoluteUrl;
          if (officeExtPattern.test(rawPath)) {
            finalUrl = absoluteUrl + '?web=1';
          }

          // 3. Encode it so spaces â†’ %20, etc.
          const encodedUrl = encodeURI(finalUrl);
          copiedValue = encodedUrl;

          bodyText = 'Copied URL: ' + encodedUrl;

          try {
            await navigator.clipboard.writeText(encodedUrl);
            success = true;
          } catch (e) {
            success = false;
            bodyText =
              'Failed to copy automatically. Copy it manually: ' + encodedUrl;
          }
        } else {
          bodyText = 'No "copy" parameter applied to URL.';
        }

        // Show message on the page
        const textnode = document.createTextNode(bodyText);
        document.body.appendChild(textnode);

        // Best-effort: close the window if clipboard still matches what we set
        if (success && copiedValue) {
          setTimeout(async () => {
            try {
              const currentClipboard = await navigator.clipboard.readText();
              if (currentClipboard === copiedValue) {
                window.close();
              }
            } catch (e) {
              // Ignore read errors; user can just close the tab
            }
          }, 500);
        }
      });
    </script>
  </head>
  <body></body>
</html>
