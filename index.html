<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Copy SharePoint Link</title>
    <script>
      window.addEventListener('load', async () => {
        const url = new URL(window.location.href);
        let bodyText;
        let success = false;
        let copiedValue = '';

        if (url.searchParams.has('copy')) {
          const rawPath = url.searchParams.get('copy'); // what SP passed

          const tenantBase = 'https://purepower.sharepoint.com';

          // If rawPath is already an absolute URL, use it as-is.
          // Otherwise, treat it as a server-relative path and prepend the tenant.
          let absoluteUrl;
          if (rawPath.startsWith('http://') || rawPath.startsWith('https://')) {
            absoluteUrl = rawPath;
          } else {
            absoluteUrl = tenantBase + rawPath;
          }

          // For Office docs, force open-in-browser with ?web=1
          const officeExtPattern = /\.(docx?|pptx?|xlsx?)$/i;
          let finalUrl = absoluteUrl;
          if (officeExtPattern.test(rawPath)) {
            // If there's already a query string, append with & instead of ?
            finalUrl += finalUrl.includes('?') ? '&web=1' : '?web=1';
          }

          // Encode it so spaces â†’ %20, etc.
          const encodedUrl = encodeURI(finalUrl);
          copiedValue = encodedUrl;

          bodyText = 'Copied URL: ' + encodedUrl;

          try {
            await navigator.clipboard.writeText(encodedUrl);
            success = true;
          } catch (e) {
            success = false;
            bodyText =
              'Failed to copy automatically. Copy it manually: ' + encodedUrl;
          }
        } else {
          bodyText = 'No "copy" parameter applied to URL.';
        }

        // Show message
        const textnode = document.createTextNode(bodyText);
        document.body.appendChild(textnode);

        // Best-effort close
        if (success && copiedValue) {
          setTimeout(async () => {
            try {
              const currentClipboard = await navigator.clipboard.readText();
              if (currentClipboard === copiedValue) {
                window.close();
              }
            } catch (e) {
              // ignore
            }
          }, 500);
        }
      });
    </script>
  </head>
  <body></body>
</html>
