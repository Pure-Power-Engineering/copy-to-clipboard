<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Copy SharePoint Link</title>
    <script>
      window.addEventListener('load', async () => {
        const href = window.location.href;
        const marker = '?copy=';
        let bodyText;
        let success = false;
        let copiedValue = '';

        const idx = href.indexOf(marker);

        if (idx !== -1) {
          // Everything after "?copy=" (including any & or other characters)
          let rawPath = href.substring(idx + marker.length);

          // Decode any %xx that might already be there
          rawPath = decodeURIComponent(rawPath);

          const tenantBase = 'https://purepower.sharepoint.com';

          // If rawPath is already an absolute URL, use it as-is.
          // Otherwise, treat it as a server-relative path.
          let absoluteUrl;
          if (rawPath.startsWith('http://') || rawPath.startsWith('https://')) {
            absoluteUrl = rawPath;
          } else {
            absoluteUrl = tenantBase + rawPath;
          }

          // For Office docs, force open-in-browser with ?web=1
          const officeExtPattern = /\.(docx?|pptx?|xlsx?)($|\?)/i;
          let finalUrl = absoluteUrl;
          if (officeExtPattern.test(absoluteUrl)) {
            finalUrl += finalUrl.includes('?') ? '&web=1' : '?web=1';
          }

          // Encode it so spaces â†’ %20, etc.
          const encodedUrl = encodeURI(finalUrl);
          copiedValue = encodedUrl;

          bodyText = 'Copied URL: ' + encodedUrl;

          try {
            await navigator.clipboard.writeText(encodedUrl);
            success = true;
          } catch (e) {
            success = false;
            bodyText =
              'Failed to copy automatically. Copy it manually: ' + encodedUrl;
          }
        } else {
          bodyText = 'No "copy" parameter applied to URL.';
        }

        // Show status on the page
        const textnode = document.createTextNode(bodyText);
        document.body.appendChild(textnode);

        // Best-effort: close the tab if clipboard still matches our value
        if (success && copiedValue) {
          setTimeout(async () => {
            try {
              const currentClipboard = await navigator.clipboard.readText();
              if (currentClipboard === copiedValue) {
                window.close();
              }
            } catch (e) {
              // ignore; user can just close the tab
            }
          }, 500);
        }
      });
    </script>
  </head>
  <body></body>
</html>

